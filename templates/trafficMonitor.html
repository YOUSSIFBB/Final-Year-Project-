<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Traffic Monitoring Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <div class="dashboard">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2 class="sidebar-title">Dashboard</h2>
      <ul class="sidebar-menu">
        <li><a href="{{ url_for('home') }}">Home</a></li>
        <li><a href="{{ url_for('scan_page') }}">Port Scan</a></li>
        <li><a class="active" href="{{ url_for('vscan_page') }}">Traffic Monitor</a></li>
        <li><a href="{{ url_for('file_scan') }}">File Scanner</a></li>
        <li><a href="{{ url_for('logout') }}">Logout</a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>Traffic Monitoring Dashboard</h1>
      </div>

      <div class="container">
        <h2 class="title">Real-Time Traffic Capture</h2>
        <div id="status" class="status-message">Click "Start Capture" to begin capturing network traffic.</div>

        <!-- Filter Dropdown -->
        <div style="margin-bottom: 10px;">
          <label for="protocolFilter"><strong>Filter by Protocol:</strong></label>
          <select id="protocolFilter" onchange="filterPackets()" class="btn">
            <option value="all">All</option>
            <option value="ARP">ARP</option>
            <option value="TCP">TCP</option>
            <option value="UDP">UDP</option>
            <option value="ICMP">ICMP</option>
            <option value="DNS">DNS</option>
            <option value="Ether">Ether</option>
          </select>
        </div>

        <!-- Capture Button -->
        <button class="btn start-capture" onclick="startCapture()">Start Capture</button>

        <!-- Packet Table -->
        <table id="packetTable" class="packet-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Protocol</th>
              <th>Source</th>
              <th>Destination</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    let packetList = [];

    async function startCapture() {
      const status = document.getElementById("status");
      const tableBody = document.querySelector("#packetTable tbody");

      status.textContent = "Capturing packets...";
      tableBody.innerHTML = "";
      packetList = [];

      try {
        const response = await fetch("/capturePackets");
        const data = await response.json();

        if (!Array.isArray(data)) {
          status.textContent = "Failed to retrieve packets.";
          return;
        }

        status.textContent = `Captured ${data.length} packets.`;
        packetList = data;
        renderPackets(data);
      } catch (err) {
        status.textContent = `Error: ${err.message}`;
      }
    }

    function filterPackets() {
      const selected = document.getElementById("protocolFilter").value;
      if (selected === "all") {
        renderPackets(packetList);
      } else {
        const filtered = packetList.filter(p =>
          p.protocol.toLowerCase().includes(selected.toLowerCase())
        );
        renderPackets(filtered);
      }
    }

    function renderPackets(packets) {
      const tableBody = document.querySelector("#packetTable tbody");
      tableBody.innerHTML = "";

      packets.forEach((pkt, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${index + 1}</td>
          <td><span class="protocol-tag ${pkt.protocol.toLowerCase()}">${pkt.protocol}</span></td>
          <td>${pkt.source}</td>
          <td>${pkt.destination}</td>
          <td>${pkt.details}</td>
        `;
        tableBody.appendChild(row);
      });
    }
  </script>
</body>
</html>
